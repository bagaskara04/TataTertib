<?php
// Include database connection
include('../koneksi.php');

// Get the laporan_id from the GET request
$laporan_id = isset($_GET['id']) ? $_GET['id'] : '';

// Ensure that the ID is provided
if (empty($laporan_id)) {
    echo json_encode(array("message" => "Report ID is missing"));
    exit();
}

// Query to fetch the violation report details based on ID
$query = "SELECT 
    p.pengaduan_id,
    d.nama AS dosen_nama,
    m.nama AS mahasiswa_nama,
    m.nim,
    pelang.pelanggaran,
    pelang.tingkat,
    sp.nama_sanksi AS sanksi,
    p.bukti_pelanggaran,
    p.tanggal_pengaduan,
    p.status_pengaduan,
    p.catatan
FROM pengaduan p
JOIN dosen d ON p.nip = d.nip
JOIN mahasiswa m ON p.nim = m.nim
JOIN pelanggaran pelang ON p.pelanggaran_id = pelang.pelanggaran_id
JOIN sanksi_pelanggaran sp ON pelang.sanksi_id = sp.sanksi_id
WHERE p.pengaduan_id = ?"; // Replace with your actual table name // Replace with your actual table name

// Prepare the query
$sqlsrv_query = sqlsrv_prepare($conn, $query, array(&$laporan_id));

// Execute the query
if (sqlsrv_execute($sqlsrv_query)) {
    $row = sqlsrv_fetch_array($sqlsrv_query, SQLSRV_FETCH_ASSOC);

    if ($row) {
        // Return the detail data as JSON
        echo json_encode($row);
    } else {
        // No report found with the given ID
        echo json_encode(array("message" => "Report not found"));
    }
} else {
    // Query execution failed
    echo json_encode(array("message" => "Failed to execute query"));
}

// Close the database connection
sqlsrv_close($conn);
?>
